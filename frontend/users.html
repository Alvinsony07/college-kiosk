<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Customer – College Kiosk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --brand: #004080;
      --bg: #f5f7fb;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #0ea5e9;
      --success: #16a34a;
      --danger: #dc2626;
      --warning: #f59e0b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      color: #0f172a;
    }
    header {
      background: var(--brand); color:#fff; padding: 18px 24px; display:flex; align-items:center; justify-content:space-between;
    }
    header h1 { margin:0; font-size: 20px; font-weight: 700; letter-spacing:.2px; }
    header .user {
      font-size: 14px; opacity:.95;
    }
    header .user-actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .logout-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s ease;
    }
    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    .modal {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }
    .modal-overlay.show .modal {
      transform: scale(1);
    }
    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 8px;
    }
    .modal-message {
      color: var(--muted);
      margin-bottom: 20px;
    }
    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    .btn-cancel {
      background: #f1f5f9;
      color: #64748b;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }
    .btn-confirm {
      background: var(--danger);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }
    .wrap { max-width: 1100px; margin: 20px auto; padding: 0 16px; }

    .layout { display:grid; grid-template-columns: 1fr 360px; gap: 18px; align-items:start; }
    @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }

    .card {
      background: var(--card); border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,.06);
      padding: 16px;
    }
    .section-title { margin: 0 0 12px; font-size: 18px; color: var(--brand); }

    /* Menu grid */
    .menu-grid {
      display: grid; gap: 16px;
      grid-template-columns: repeat(4, 1fr);
    }
    
    @media (max-width: 1200px) {
      .menu-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 900px) {
      .menu-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 600px) {
      .menu-grid {
        grid-template-columns: 1fr;
      }
    }
    .item {
      display:flex; flex-direction: column; gap:10px; padding: 0; border:1px solid #e5e7eb; border-radius: 12px;
      transition: all .3s ease;
      background: #fff;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .item:hover { 
      box-shadow: 0 4px 16px rgba(0,0,0,.12); 
      transform: translateY(-2px);
      border-color: var(--accent);
    }
    .thumb {
      width: 100%; height: 140px; object-fit: cover; background:#f3f4f6;
    }
    .item-content {
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .row { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .name { font-weight: 600; font-size: 14px; line-height: 1.3; color: #0f172a; }
    .muted { color: var(--muted); font-size: 11px; }
    .price { font-weight: 700; font-size: 16px; color: var(--brand); }
    .category-info {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .category-badge {
      font-size: 9px; 
      padding: 3px 8px; 
      border-radius: 10px; 
      background: var(--success); 
      color: white;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.3px;
    }
    .category-badge.bev {
      background: var(--info);
    }
    .category-badge.shake {
      background: var(--warning);
    }
    .stock-chip {
      font-size: 10px; padding: 3px 8px; border-radius: 10px; background: #eef2ff; color:#3730a3;
      display: flex;
      align-items: center;
      gap: 3px;
    }
    .deliverable-chip {
      font-size: 9px; 
      padding: 3px 6px; 
      border-radius: 6px; 
      background: #f0f9ff; 
      color: #0369a1;
      display: flex;
      align-items: center;
      gap: 3px;
    }
    .qty-wrap { 
      display:flex; 
      align-items:center; 
      gap:6px; 
      background: #f8fafc;
      padding: 6px 10px;
      border-radius: 10px;
    }
    .qty-wrap label {
      font-size: 11px;
      font-weight: 500;
      color: var(--muted);
    }
    input[type="number"] {
      width: 60px; padding:6px 8px; border:1px solid #e5e7eb; border-radius: 6px; font: inherit;
      text-align: center;
      font-size: 12px;
    }
    .btn-add {
      background: var(--brand);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 12px;
    }
    .btn-add:hover:not(:disabled) {
      background: #003d7a;
      transform: translateY(-1px);
    }
    .btn-add:disabled {
      background: #e5e7eb;
      color: #9ca3af;
      cursor: not-allowed;
    }
    button {
      border: 0; border-radius: 10px; padding: 8px 12px; cursor: pointer; font-weight: 600;
    }
    .btn-add { background: var(--accent); color:#fff; }
    .btn-add:disabled { opacity:.5; cursor:not-allowed; }
    .btn-outline {
      background: #fff; border:1px solid #e5e7eb; color:#111827;
    }

    /* Cart */
    .cart-empty { text-align:center; color: var(--muted); padding: 20px 8px; }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding: 8px; border-bottom: 1px solid #eef2f7; font-size: 14px; }
    th { color: var(--muted); font-weight: 600; }
    .right { text-align:right; }
    .danger { background: var(--danger); color:#fff; }
    .success { background: var(--success); color:#fff; }
    .checkout-bar {
      margin-top: 10px; display:flex; align-items:center; justify-content:space-between; gap: 10px;
    }
    .total { font-weight: 800; font-size: 18px; }

    /* Modal */
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(2,6,23,.55); display:none; align-items:center; justify-content:center; padding: 18px;
    }
    .modal { width: 100%; max-width: 460px; background:#fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.18); }
    .modal header { padding: 14px 16px; background:#0f172a; color:#fff; border-radius: 12px 12px 0 0; }
    .modal .body { padding: 16px; display:flex; flex-direction:column; gap:10px; }
    .field { display:flex; flex-direction:column; gap:6px; }
    .field label { font-size: 13px; color:#374151; }
    .field input { padding: 10px 12px; border:1px solid #e5e7eb; border-radius: 10px; font: inherit; }
    .modal .actions { padding: 12px 16px; display:flex; justify-content:flex-end; gap:10px; }
  </style>
</head>
<body>
  <header>
    <h1>College Kiosk — Customer</h1>
    <div class="user-actions">
      <div class="user" id="userBadge">Loading…</div>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>
  </header>

  <!-- Logout Confirmation Modal -->
  <div id="logoutModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-title">Confirm Logout</div>
      <div class="modal-message">Are you sure you want to logout? You will be redirected to the login page.</div>
      <div class="modal-actions">
        <button class="btn-cancel" id="cancelLogout">Cancel</button>
        <button class="btn-confirm" id="confirmLogout">Logout</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="layout">
      <!-- MENU -->
      <section class="card">
        <h2 class="section-title">Menu</h2>
        <div id="menuGrid" class="menu-grid"></div>
      </section>

      <!-- CART -->
      <aside class="card">
        <h2 class="section-title">Your Cart</h2>
        <div id="cartWrap">
          <div class="cart-empty" id="cartEmpty">Your cart is empty.</div>
          <div id="cartTableWrap" style="display:none;">
            <table>
              <thead>
                <tr>
                  <th>Item</th>
                  <th class="right">Qty</th>
                  <th class="right">Price</th>
                  <th class="right">Subtotal</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="cartBody"></tbody>
            </table>
            <div class="checkout-bar">
              <div class="total">Total: ₹<span id="cartTotal">0.00</span></div>
              <button class="success" id="btnCheckout">Checkout</button>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <header><strong>Confirm Order</strong></header>
      <div class="body">
        <div class="field">
          <label for="custName">Name</label>
          <input id="custName" placeholder="Your full name" />
        </div>
        <div class="field">
          <label for="custEmail">Email</label>
          <input id="custEmail" placeholder="you@college.edu" />
        </div>
        <div class="field">
          <label>Order Type</label>
          <div>
            <label><input type="radio" name="orderType" value="pickup" checked> Pickup</label>
            <label style="margin-left:15px;"><input type="radio" name="orderType" value="delivery"> Delivery</label>
          </div>
        </div>
        <!-- Delivery details -->
        <div class="field delivery-field" style="display:none;">
          <label for="custClass">Classroom</label>
          <input id="custClass" placeholder="Classroom no." />
        </div>
        <div class="field delivery-field" style="display:none;">
          <label for="custDept">Department</label>
          <input id="custDept" placeholder="Department" />
        </div>
        <div class="field delivery-field" style="display:none;">
          <label for="custBlock">Block</label>
          <input id="custBlock" placeholder="Block name" />
        </div>
        <div class="field delivery-field" style="display:none;">
          <label for="custTime">Expected Delivery Time</label>
          <input id="custTime" type="time" />
        </div>
        <div class="field">
          <label>Order Summary</label>
          <div id="summaryBox" style="font-size:14px; color:#374151;"></div>
        </div>
      </div>
      <div class="actions">
        <button class="btn-outline" id="btnCancel">Cancel</button>
        <button class="success" id="btnPlace">Place Order</button>
      </div>
    </div>
  </div>

  <script>
    // ------------------ State ------------------
    let MENU = [];
    const CART = new Map();

    function getUser() {
      try { return JSON.parse(localStorage.getItem('user') || 'null'); }
      catch { return null; }
    }

    function formatCurrency(n) { return Number(n).toFixed(2); }

    function getCategoryClass(category) {
      const cat = (category || '').toLowerCase();
      if (cat.includes('veg') || cat.includes('food')) return 'veg';
      if (cat.includes('bev') || cat.includes('drink') || cat.includes('tea') || cat.includes('coffee')) return 'bev';
      if (cat.includes('shake') || cat.includes('smoothie')) return 'shake';
      return 'veg'; // default
    }

    function renderUserBadge() {
      const user = getUser();
      const badge = document.getElementById('userBadge');
      badge.textContent = user && user.email ? `${user.name || user.email} — ${user.email}` : 'Guest';
    }

    function renderMenu() {
      const grid = document.getElementById('menuGrid');
      grid.innerHTML = '';

      const available = MENU.filter(m => !!m.available && Number(m.stock) > 0);
      if (available.length === 0) {
        grid.innerHTML = '<div class="muted">No items available right now.</div>';
        return;
      }

      for (const m of available) {
        const card = document.createElement('div');
        card.className = 'item';
        const imgSrc = m.image ? `/static/images/${m.image}` : '';
        const categoryClass = getCategoryClass(m.category);
        
        card.innerHTML = `
          <img class="thumb" src="${imgSrc}" alt="${m.name}" onerror="this.src='';this.style.background='#eef2ff'">
          <div class="item-content">
            <div class="row">
              <div class="name">${m.name}</div>
              <div class="price">₹${formatCurrency(m.price)}</div>
            </div>
            <div class="category-info">
              <span class="category-badge ${categoryClass}">${m.category || 'Food'}</span>
              <div class="stock-chip">
                <i class="fas fa-box" style="font-size: 10px;"></i>
                ${m.stock} left
              </div>
              ${m.deliverable ? '<div class="deliverable-chip"><i class="fas fa-truck" style="font-size: 10px;"></i> Deliverable</div>' : ''}
            </div>
            <div class="row">
              <div class="qty-wrap">
                <label for="qty-${m.id}">Qty</label>
                <input type="number" id="qty-${m.id}" min="1" max="${m.stock}" value="1">
              </div>
              <button class="btn-add" ${Number(m.stock) <= 0 ? 'disabled' : ''} onclick="addToCart(${m.id})">
                <i class="fas fa-plus"></i>
                Add to Cart
              </button>
            </div>
          </div>
        `;
        grid.appendChild(card);
      }
    }

    function renderCart() {
      const empty = document.getElementById('cartEmpty');
      const wrap = document.getElementById('cartTableWrap');
      const body = document.getElementById('cartBody');
      const totalEl = document.getElementById('cartTotal');
      if (CART.size === 0) {
        empty.style.display = ''; wrap.style.display = 'none';
        body.innerHTML = ''; totalEl.textContent = '0.00'; return;
      }
      empty.style.display = 'none'; wrap.style.display = ''; let total = 0;
      body.innerHTML = '';
      for (const item of CART.values()) {
        const sub = item.price * item.qty; total += sub;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><div style="display:flex; align-items:center; gap:8px;">
            <img src="/static/images/${item.image}" alt="${item.name}" style="width:50px; height:50px; object-fit:cover; border-radius:6px;" onerror="this.style.display='none'">
            <span>${item.name}</span></div></td>
          <td class="right"><input type="number" min="1" max="${item.max}" value="${item.qty}" style="width:64px" onchange="changeQty(${item.id}, this.value)"></td>
          <td class="right">₹${formatCurrency(item.price)}</td>
          <td class="right">₹${formatCurrency(sub)}</td>
          <td class="right"><button class="danger" onclick="removeFromCart(${item.id})">Remove</button></td>`;
        body.appendChild(tr);
      }
      totalEl.textContent = formatCurrency(total);
    }

    window.addToCart = function(id) {
      const item = MENU.find(x => x.id === id); if (!item) return;
      const qtyInput = document.getElementById(`qty-${id}`);
      const qty = Math.max(1, Math.min(Number(qtyInput.value || 1), Number(item.stock)));
      if (CART.has(id)) {
        const inCart = CART.get(id); inCart.qty = Math.min(inCart.qty + qty, Number(item.stock)); CART.set(id, inCart);
      } else {
        CART.set(id, { id: item.id, name: item.name, price: Number(item.price), qty, max: Number(item.stock), image: item.image || '', deliverable: item.deliverable });
      }
      renderCart();
    };

    window.changeQty = function(id, v) { const inCart = CART.get(id); if (!inCart) return; inCart.qty = Math.max(1, Math.min(Number(v||1), inCart.max)); CART.set(id, inCart); renderCart(); };
    window.removeFromCart = function(id) { CART.delete(id); renderCart(); };

    function openModal() {
      const user = getUser();
      document.getElementById('custName').value = (user && user.name) ? user.name : '';
      document.getElementById('custEmail').value = (user && user.email) ? user.email : '';
      let lines = [], total = 0;
      for (const it of CART.values()) { const sub = it.price * it.qty; total += sub; lines.push(`${it.name} × ${it.qty} — ₹${formatCurrency(sub)}`); }
      lines.push(`— — —`); lines.push(`Total: ₹${formatCurrency(total)}`);
      document.getElementById('summaryBox').innerHTML = lines.join('<br>');
      const m = document.getElementById('modalBackdrop'); m.style.display = 'flex'; m.setAttribute('aria-hidden', 'false');
    }
    function closeModal() { const m = document.getElementById('modalBackdrop'); m.style.display = 'none'; m.setAttribute('aria-hidden', 'true'); }

    async function placeOrder() {
      if (CART.size === 0) return;
      const name = document.getElementById('custName').value.trim();
      const email = document.getElementById('custEmail').value.trim();
      const orderType = document.querySelector('input[name="orderType"]:checked').value;
      if (!name || !email) { alert('Please enter your name and email.'); return; }
      const items = []; let total = 0;
      for (const it of CART.values()) { items.push({ id: it.id, qty: it.qty }); total += it.price * it.qty; }
      const orderDetails = { customer_name: name, customer_email: email, items: items, total_price: Number(total.toFixed(2)), delivery_mode: orderType };
      if (orderType === 'delivery') {
        orderDetails.classroom = document.getElementById('custClass').value.trim();
        orderDetails.department = document.getElementById('custDept').value.trim();
        orderDetails.block = document.getElementById('custBlock').value.trim();
        orderDetails.expected_time = document.getElementById('custTime').value.trim();
      }
      try {
        const res = await fetch('/api/orders', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(orderDetails) });
        const data = await res.json(); if (!res.ok) { alert(data?.error || 'Failed to place order'); return; }
        alert(`Order placed!\nFinal Price: ₹${data.final_price}\nYour OTP: ${data.otp}`);
        CART.clear(); closeModal(); renderCart(); await loadMenu();
      } catch (err) { console.error(err); alert('Network error while placing order.'); }
    }

    async function loadMenu() {
      try {
        const res = await fetch('/api/menu'); const raw = await res.json();
        MENU = raw.map(row => Array.isArray(row) ? { id: row[0], name: row[1], price: row[2], category: row[3], stock: row[4], available: row[5], image: row[6], deliverable: row[7] } : row);
        renderMenu();
      } catch (err) { console.error(err); }
    }

    document.getElementById('btnCheckout').addEventListener('click', () => { if (CART.size === 0) return alert('Your cart is empty.'); openModal(); });
    document.getElementById('btnCancel').addEventListener('click', closeModal);
    document.getElementById('btnPlace').addEventListener('click', placeOrder);

    // Toggle delivery fields
    document.querySelectorAll('input[name="orderType"]').forEach(r => {
      r.addEventListener('change', () => {
        const fields = document.querySelectorAll('.delivery-field');
        if (r.value === 'delivery' && r.checked) { fields.forEach(f => f.style.display = ''); }
        else { fields.forEach(f => f.style.display = 'none'); }
      });
    });

    // ------------------ Logout Functions ------------------
    function showLogoutModal() {
      document.getElementById('logoutModal').classList.add('show');
    }

    function hideLogoutModal() {
      document.getElementById('logoutModal').classList.remove('show');
    }

    function performLogout() {
      hideLogoutModal();
      
      // Clear user data
      localStorage.removeItem('user');
      sessionStorage.removeItem('user');
      
      // Redirect to login page
      setTimeout(() => {
        window.location.href = '/';
      }, 500);
    }

    // Logout event listeners
    document.getElementById('logoutBtn').addEventListener('click', showLogoutModal);
    document.getElementById('cancelLogout').addEventListener('click', hideLogoutModal);
    document.getElementById('confirmLogout').addEventListener('click', performLogout);
    
    // Close modal when clicking overlay
    document.getElementById('logoutModal').addEventListener('click', (e) => {
      if (e.target.id === 'logoutModal') {
        hideLogoutModal();
      }
    });

    // ------------------ Init ------------------
    renderUserBadge(); loadMenu(); renderCart();
  </script>
</body>
</html>
